<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ccp.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<a href="{{ url_for('index') }}" class="back-button">← Back to Dashboard</a>

<div class="user-box">
    <span class="greeting">Hello, {{ current_user.name }}!</span>
    <form action="{{ url_for('logout') }}" method="get">
        <button type="submit" class="logout-btn">Logout</button>
    </form>
</div>

 <div style="display: flex; justify-content: center; align-items: center;">
    <h1 style="display: inline;"><a href="https://www.ccpstudentnews.org" style="font-family: 'Brush Script MT'; text-decoration: none; color: #222; font-size: 45px;">Cardinal and White&nbsp; </a></h1><h1 style="display: inline;">Calendar</h1>
    </div>


<div id="calendar"></div>

   <script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: '/api/calendar_events',
        editable: false,
        selectable: false,
        aspectRatio: 2,
        height: '100%',
        contentHeight: 'auto',
        dayMaxEvents: true,
        timeZone: 'local',

        
        eventDidMount: function(info) {
            info.el.style.cursor = 'pointer';
        },

        eventClick: function(info) {
            info.jsEvent.preventDefault();
            let event = info.event;

     
            function formatLocalDateTime(date) {
                if (!date) return '';
                const offset = date.getTimezoneOffset();
                const localDate = new Date(date.getTime() - offset * 60000);
                return localDate.toISOString().slice(0,16);
            }

            let popup = document.createElement("div");
            popup.id = "event-popup";
            popup.style.position = "fixed";
            popup.style.top = "50%";
            popup.style.left = "50%";
            popup.style.transform = "translate(-50%, -50%)";
            popup.style.background = "#fff";
            popup.style.border = "1px solid #ccc";
            popup.style.padding = "20px";
            popup.style.zIndex = 1000;
            popup.style.borderRadius = "10px";
            popup.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
            popup.style.maxWidth = "400px";
            popup.style.width = "90%";

            popup.innerHTML = `
                <h2>Edit Event</h2>
                <label>Title: <input type="text" id="edit-title" value="${event.title}"></label><br>
                <label>Description: <textarea id="edit-description">${event.extendedProps.description || ''}</textarea></label><br>
                <label>Location: <input type="text" id="edit-location" value="${event.extendedProps.location || ''}"></label><br>
                <label>Start: <input type="datetime-local" id="edit-start" value="${formatLocalDateTime(event.start)}"></label><br>
                <label>End: <input type="datetime-local" id="edit-end" value="${formatLocalDateTime(event.end)}"></label><br><br>
            `;

            let saveBtn = document.createElement("button");
            saveBtn.innerText = "Save";
            saveBtn.style.marginRight = "10px";
            saveBtn.onclick = async function() {
                let payload = {
                    title: document.getElementById("edit-title").value,
                    description: document.getElementById("edit-description").value,
                    location: document.getElementById("edit-location").value,
                    start: document.getElementById("edit-start").value + ":00", // ensure seconds
                    end: document.getElementById("edit-end").value + ":00"
                };

                try {
                    let res = await fetch(`/api/update_calendar_event/${event.id}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    let json = await res.json();
                    if(json.success){
                        alert("Event updated!");
                        calendar.refetchEvents();
                        popup.remove();
                        overlay.remove();
                    } else {
                        alert("Error: " + json.message);
                    }
                } catch(err){
                    console.error(err);
                    alert("Network error.");
                }
            };

            let closeBtn = document.createElement("button");
            closeBtn.innerText = "Close";
            closeBtn.onclick = function() {
                popup.remove();
                overlay.remove();
            };

            let overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = 0;
            overlay.style.left = 0;
            overlay.style.width = "100%";
            overlay.style.height = "100%";
            overlay.style.background = "rgba(0,0,0,0.5)";
            overlay.style.zIndex = 999;
            overlay.onclick = function() {
                popup.remove();
                overlay.remove();
            };

            popup.appendChild(saveBtn);
            popup.appendChild(closeBtn);
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        }


    });

    calendar.render();

    // Socket
    var socket = io();
    socket.on('calendar_event_added', function(data) {
        calendar.addEvent(data);
    });
    socket.on('calendar_event_deleted', function(data) {
        let event = calendar.getEventById(data.id);
        if(event) event.remove();
    });
});
</script>


</body>
</html>
