<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Archived Articles</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ccp.ico') }}">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<!-- Back button -->
<a href="{{ url_for('index') }}" class="back-button">← Back to Dashboard</a>

<!-- User Info -->
<div class="user-box">
    <span class="greeting">Hello, {{ current_user.name }}!</span>
    <form action="{{ url_for('logout') }}" method="get">
        <button type="submit" class="logout-btn">Logout</button>
    </form>
</div>

<h1 style="text-align:center;">Archived Articles</h1>

<table id="archive-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 50px;">
    <thead>
        <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Editor</th>
            <th>Deadline</th>
            <th>Files</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for article in articles %}
        <tr id="row-{{ article.id }}">
            <td>{{ article.title }}</td>
            <td>{{ article.author }}</td>
            <td>{{ article.editor if article.editor else "—" }}</td>
            <td>{{ article.deadline }}</td>
            <td>
                <button class="file-icon-btn" onclick="openFileManager({{ article.id }})">Files</button>
            </td>
            <td>
                <button onclick="activateArticle({{ article.id }})" class="btn-activate">Activate</button>
                <button onclick="deleteArticle({{ article.id }})" class="btn-delete">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- File Manager Modal -->
<div id="fileManagerModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button type="button" class="close" aria-label="Close" onclick="closeFileManager()">×</button>

    <h3>Files</h3>

    <ul id="fileList" class="file-list"></ul>
    <div class="upload-section">
      <form id="uploadForm" class="typ" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" required />
        <button type="submit">Upload</button>
      </form>
    </div>
  </div>
</div>

<script>
    const socket = io();
    let currentArticleId = null;

    function activateArticle(articleId) {
        fetch(`/activate/${articleId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`row-${articleId}`).remove();
                    socket.emit('article_activated', { id: articleId });
                }
            });
    }

    function deleteArticle(articleId) {
        if (!confirm('Are you sure you want to delete this article?')) return;
        fetch(`/delete/${articleId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`row-${articleId}`).remove();
                    socket.emit('article_deleted', { id: articleId });
                }
            });
    }

    // ---------------- File Manager ----------------
    function openFileManager(articleId) {
        currentArticleId = articleId;
        const modal = document.getElementById('fileManagerModal');
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
        loadFiles(articleId);
    }

    function closeFileManager() {
        const modal = document.getElementById('fileManagerModal');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        currentArticleId = null;
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('uploadForm').reset();
    }

    function loadFiles(articleId) {
        fetch(`/files/${articleId}`)
            .then(res => res.json())
            .then(data => {
                const ul = document.getElementById('fileList');
                ul.innerHTML = '';
                (data.files || []).forEach(f => {
                    const li = document.createElement('li');
                    li.id = `file-${f.id}`;
                    li.innerHTML = `
                        <div class="file-actions">
                            <a href="/download_file/${f.id}" target="_blank">
                                <button class="download-btn">${f.filename}</button>
                            </a>
                            <button onclick="deleteFile(${f.id})" class="delete-btn">Delete</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
            });
    }

    document.getElementById('uploadForm').addEventListener('submit', e => {
        e.preventDefault();
        if (!currentArticleId) return;
        const formData = new FormData(e.target);

        fetch(`/upload/${currentArticleId}`, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) loadFiles(currentArticleId);
            });
    });

    function deleteFile(fileId) {
        if (!confirm('Delete this file?')) return;
        fetch(`/delete_file/${fileId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => { if (data.success) document.getElementById(`file-${fileId}`).remove(); });
    }

    window.addEventListener('click', e => { if (e.target.id === 'fileManagerModal') closeFileManager(); });
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closeFileManager(); });
</script>

</body>
</html>
