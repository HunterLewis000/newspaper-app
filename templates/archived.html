<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ccp.ico') }}">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<!-- Back button -->
<a href="{{ url_for('index') }}" class="back-button">← Back to Dashboard</a>

<!-- User Info -->
<div class="user-box">
    <span class="greeting">Hello, {{ current_user.name }}!</span>
    <form action="{{ url_for('logout') }}" method="get">
        <button type="submit" class="logout-btn">Logout</button>
    </form>
</div>

 <div style="display: flex; justify-content: center; align-items: center;">
    <h1 style="display: inline;"><a href="https://www.ccpstudentnews.org" style="font-family: 'Brush Script MT'; text-decoration: none; color: #222; font-size: 45px;">Cardinal and White&nbsp; </a></h1><h1 style="display: inline;">Archived Articles</h1>
    </div>

<table id="archive-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 50px;">
    <thead>
        <tr>
            <th class="arcti">Title</th>
            <th class="arcau">Author</th>
            <th class="arced">Editor</th>
            <th class="arcde">Deadline</th>
            <th class="arcfi">Files</th>
            <th class="arcac">Actions</th>
        </tr>
    </thead>
    <tbody id="archived-tbody">
        {% for article in articles %}
        <tr id="row-{{ article.id }}">
            <td class="arcti">{{ article.title }}</td>
            <td class="arcau">{{ article.author }}</td>
            <td class="arced">{{ article.editor if article.editor else "—" }}</td>
            <td class="arcde">{{ article.deadline }}</td>
            <td class="arcfi">
                <button class="file-icon-btn" onclick="openFileManager({{ article.id }})">Files</button>
            </td>
            <td class="arcac">
                <button onclick="activateArticle({{ article.id }})" class="btn-activate">Activate</button>
                <button onclick="deleteArticle({{ article.id }})" class="btn-delete">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- File Manager Modal -->
<div id="fileManagerModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button type="button" class="close" aria-label="Close" onclick="closeFileManager()">×</button>
    <h3>Files</h3>
    <ul id="fileList" class="file-list"></ul>
    <div class="upload-section">
      <form id="uploadForm" class="typ" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" required />
        <button type="submit">Upload</button>
      </form>
    </div>
  </div>
</div>

<script>
const socket = io();
let currentArticleId = null;

// ------------------- Add or Update Row -------------------
function addOrUpdateRow(article) {
    const tbody = document.getElementById('archived-tbody');
    let row = document.getElementById(`row-${article.id}`);
    if (!row) {
        row = document.createElement('tr');
        row.id = `row-${article.id}`;
        tbody.appendChild(row);
    }

    row.innerHTML = `
        <td>${article.title}</td>
        <td>${article.author}</td>
        <td>${article.editor || '—'}</td>
        <td>${article.deadline || ''}</td>
        <td>
            <button class="file-icon-btn" onclick="openFileManager(${article.id})">Files</button>
        </td>
        <td>
            <button onclick="activateArticle(${article.id})" class="btn-activate">Activate</button>
            <button onclick="deleteArticle(${article.id})" class="btn-delete">Delete</button>
        </td>
    `;
}

// ------------------- Activate Article -------------------
function activateArticle(articleId) {
    fetch(`/activate/${articleId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`row-${articleId}`);
                if (row) row.remove();
            }
        });
}

// ------------------- Delete Article -------------------
function deleteArticle(articleId) {
    if (!confirm('Are you sure you want to delete this article?')) return;
    fetch(`/delete/${articleId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const row = document.getElementById(`row-${articleId}`);
                if (row) row.remove();
                socket.emit('article_deleted', { id: articleId });
            }
        });
}

// ------------------- File Manager -------------------
function openFileManager(articleId) {
    currentArticleId = articleId;
    const modal = document.getElementById('fileManagerModal');
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    loadFiles(articleId);
}

function closeFileManager() {
    const modal = document.getElementById('fileManagerModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    currentArticleId = null;
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('uploadForm').reset();
}

function loadFiles(articleId) {
    fetch(`/files/${articleId}`)
        .then(res => res.json())
        .then(data => {
            const ul = document.getElementById('fileList');
            ul.innerHTML = '';
            (data.files || []).forEach(f => {
                const li = document.createElement('li');
                li.id = `file-${f.id}`;
                li.innerHTML = `
                    <div class="file-actions">
                        <a href="/download_file/${f.id}" target="_blank">
                            <button class="download-btn">${f.filename}</button>
                        </a>
                        <button onclick="deleteFile(${f.id})" class="delete-btn">Delete</button>
                    </div>
                `;
                ul.appendChild(li);
            });
        });
}

document.getElementById('uploadForm').addEventListener('submit', e => {
    e.preventDefault();
    if (!currentArticleId) return;
    const formData = new FormData(e.target);
    fetch(`/upload/${currentArticleId}`, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => { if (data.success) loadFiles(currentArticleId); });
});

function deleteFile(fileId) {
    if (!confirm('Delete this file?')) return;
    fetch(`/delete_file/${fileId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => { if (data.success) document.getElementById(`file-${fileId}`).remove(); });
}

window.addEventListener('click', e => { if (e.target.id === 'fileManagerModal') closeFileManager(); });
window.addEventListener('keydown', e => { if (e.key === 'Escape') closeFileManager(); });

// ------------------- Socket.IO Listeners -------------------
socket.on('article_archived', data => {
    fetch(`/article/${data.id}`)
        .then(res => res.json())
        .then(article => addOrUpdateRow(article));
});

socket.on('article_activated', data => {
    const row = document.getElementById(`row-${data.id}`);
    if (row) row.remove();
});


socket.on('article_deleted', data => {
    const row = document.getElementById(`row-${data.id}`);
    if (row) row.remove();
});

socket.on('file_uploaded', data => { if (currentArticleId === data.articleId) loadFiles(currentArticleId); });
socket.on('file_deleted', data => { const li = document.getElementById(`file-${data.file_id}`); if (li) li.remove(); });

</script>
</body>
</html>
