<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ccp.ico') }}">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<!-- Back button -->
<a href="{{ url_for('index') }}" class="back-button">← Back to Dashboard</a>

<div class="user-box">
  <span class="greeting">Hello, {{ current_user.name }}!</span>
      {% if current_user.is_authenticated and current_user.email in ALLOWED_EMAILS %}
    <form action="{{ url_for('manage') }}" method="get" class="manage-form">
        <button type="submit" class="settings-btn">⚙</button>
    </form>
    {% endif %}
  <form action="{{ url_for('logout') }}" method="get">
    <button type="submit">Logout</button>
  </form>
</div>

 <div style="display: flex; justify-content: center; align-items: center;">
    <h1 style="display: inline;"><a href="https://www.ccpstudentnews.org" style="font-family: 'Brush Script MT'; text-decoration: none; color: #222; font-size: 45px;">Cardinal and White&nbsp; </a></h1><h1 style="display: inline;">Archived Articles</h1>
    </div>

<!-- Search form -->
<div style="text-align:center; margin-top:18px;">
  <form method="get" action="{{ url_for('archived') }}" class="search-form">
    <input type="search" name="q" class="search-input" placeholder="Search title or author" value="{{ q or '' }}" aria-label="Search archived articles" />
    <button type="submit" class="search-btn">Search</button>
    {% if q %}
      <a class="pager-button" href="{{ url_for('archived') }}" title="Clear search" style="margin-left:6px;">× Clear</a>
    {% endif %}
  </form>
</div>

<table id="archive-table" border="1" style="width:100%; border-collapse: collapse; margin-top: 22px;">
    <thead>
        <tr>
            <th class="arcti">Title</th>
            <th class="arcau">Author</th>
            <th class="arced">Editor</th>
            <th class="arcde">Deadline</th>
            <th class="arcfi">Files</th>
            <th class="arcac">Actions</th>
        </tr>
    </thead>
    <tbody id="archived-tbody">
        {% for article in articles %}
        <tr id="row-{{ article.id }}">
            <td class="arcti">{{ article.title }}</td>
            <td class="arcau">{{ article.author }}</td>
            <td class="arced">{{ article.editor if article.editor else "—" }}</td>
            <td class="arcde">{{ article.deadline }}</td>
            <td class="arcfi">
                <button class="file-icon-btn" onclick="openFileManager({{ article.id }})">Files</button>
            </td>
            <td class="arcac">
                <button onclick="activateArticle({{ article.id }})" class="btn-activate">Activate</button>
                <button onclick="deleteArticle({{ article.id }})" class="btn-delete">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="pagination" style="text-align:center; margin-top:16px;">
  {% if total > 0 %}
    <nav aria-label="Archived pages">
      {% if page > 1 %}
        <a class="pager-button" href="{{ url_for('archived', page=page-1, q=q) }}">&larr; Previous</a>
      {% else %}
        <span class="pager-button disabled">&larr; Previous</span>
      {% endif %}

      <span style="margin: 0 12px;">Page {{ page }} of {{ total_pages }} ({{ total }} articles)</span>

      {% if page < total_pages %}
        <a class="pager-button" href="{{ url_for('archived', page=page+1, q=q) }}">Next &rarr;</a>
      {% else %}
        <span class="pager-button disabled">Next &rarr;</span>
      {% endif %}
    </nav>
  {% endif %}
</div>

<!-- File Manager Modal -->
<div id="fileManagerModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button type="button" class="close" aria-label="Close" onclick="closeFileManager()">×</button>
    <h3>Files</h3>
    <ul id="fileList" class="file-list"></ul>
    <div class="upload-section">
      <form id="uploadForm" class="typ" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" required />
        <button type="submit">Upload</button>
      </form>
    </div>
  </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', () => {
  const socket = io();
  window.currentArticleId = null;

  // Add or Update Row
  window.addOrUpdateRow = function(article) {
      const tbody = document.getElementById('archived-tbody');
      let row = document.getElementById(`row-${article.id}`);
      if (!row) {
          row = document.createElement('tr');
          row.id = `row-${article.id}`;
          tbody.appendChild(row);
      }

      row.innerHTML = `
          <td>${article.title}</td>
          <td>${article.author}</td>
          <td>${article.editor || '—'}</td>
          <td>${article.deadline || ''}</td>
          <td>
              <button class="file-icon-btn" onclick="openFileManager(${article.id})">Files</button>
          </td>
          <td>
              <button onclick="activateArticle(${article.id})" class="btn-activate">Activate</button>
              <button onclick="deleteArticle(${article.id})" class="btn-delete">Delete</button>
          </td>
      `;
  };

  // Activate Article
  window.activateArticle = function(articleId) {
      fetch(`/activate/${articleId}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                  const row = document.getElementById(`row-${articleId}`);
                  if (row) row.remove();
              } else {
                  console.warn('Activate failed', data);
              }
          })
          .catch(err => console.error('Activate error', err));
  };

  // Delete Article
  window.deleteArticle = function(articleId) {
      if (!confirm('Are you sure you want to delete this article?')) return;
      fetch(`/delete/${articleId}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                  const row = document.getElementById(`row-${articleId}`);
                  if (row) row.remove();
                  socket.emit('article_deleted', { id: articleId });
              } else {
                  console.warn('Delete failed', data);
              }
          })
          .catch(err => console.error('Delete error', err));
  };

  // File Manager
  window.openFileManager = function(articleId) {
      window.currentArticleId = articleId;
      const modal = document.getElementById('fileManagerModal');
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      loadFiles(articleId);
  };

  window.closeFileManager = function() {
      const modal = document.getElementById('fileManagerModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      window.currentArticleId = null;
      document.getElementById('fileList').innerHTML = '';
      const uf = document.getElementById('uploadForm');
      if (uf) uf.reset();
  };

  function loadFiles(articleId) {
      const ul = document.getElementById('fileList');

      ul.innerHTML = '<li class="loading">Loading…</li>';

      fetch(`/files/${articleId}`)
          .then(res => res.json())
          .then(data => {
              ul.innerHTML = '';

              (data.files || []).forEach(f => {
                  const li = document.createElement('li');
                  li.id = `file-${f.id}`;
                  li.innerHTML = `
                      <div class="file-actions">
                          <a href="/download_file/${f.id}" target="_blank">
                              <button class="download-btn">${f.filename}</button>
                          </a>
                      </div>
                  `;
                  ul.appendChild(li);
              });
          })
          .catch(err => {
              console.error('Load files error', err);
              ul.innerHTML = '<li class="error">Failed to load files</li>';
          });
  }

  const uploadForm = document.getElementById('uploadForm');
  if (uploadForm) {
      uploadForm.addEventListener('submit', async e => {
          e.preventDefault();
          if (!window.currentArticleId) return;

          const fileInput = document.getElementById('fileInput');
          if (!fileInput || !fileInput.files.length) return;

          const formData = new FormData(e.target);

          const uploadBtn = e.target.querySelector('button[type="submit"]');
          if (uploadBtn) {
              uploadBtn.disabled = true;
              uploadBtn.textContent = "Wait...";
          }

          try {
              const res = await fetch(`/upload/${window.currentArticleId}`, {
                  method: 'POST',
                  body: formData
              });
              const data = await res.json();

              if (data.success) {
                  fileInput.value = "";
                  loadFiles(window.currentArticleId);
              } else {
                  alert("Upload failed: " + (data.message || "Unknown error"));
              }
          } catch (err) {
              alert("Upload failed. Please try again.");
              console.error('Upload error', err);
          } finally {
              if (uploadBtn) {
                  uploadBtn.disabled = false;
                  uploadBtn.textContent = "Upload";
              }
          }
      });
  }

  window.deleteFile = function(fileId) {
      if (!confirm('Delete this file?')) return;
      fetch(`/delete_file/${fileId}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                  const el = document.getElementById(`file-${fileId}`);
                  if (el) el.remove();
              }
          })
          .catch(err => console.error('Delete file error', err));
  };

  window.addEventListener('click', e => { if (e.target.id === 'fileManagerModal') closeFileManager(); });
  window.addEventListener('keydown', e => { if (e.key === 'Escape') closeFileManager(); });

  // Socket.IO Listeners
  socket.on('article_archived', data => {
      fetch(`/article/${data.id}`)
          .then(res => res.json())
          .then(article => addOrUpdateRow(article))
          .catch(err => console.error('socket article_archived fetch error', err));
  });

  socket.on('article_activated', data => {
      const row = document.getElementById(`row-${data.id}`);
      if (row) row.remove();
  });

  socket.on('article_deleted', data => {
      const row = document.getElementById(`row-${data.id}`);
      if (row) row.remove();
  });

  socket.on('file_uploaded', data => { if (window.currentArticleId === data.articleId) loadFiles(window.currentArticleId); });
  socket.on('file_deleted', data => { const li = document.getElementById(`file-${data.file_id}`); if (li) li.remove(); });

});
</script>
</body>
</html>
