<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ccp.ico') }}">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
     <style>
        body { font-family: Arial, sans-serif; padding: 16px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th.date-col { position: sticky; top: 0; background: #fafafa; z-index: 1; }
        th.person { background: #f0f0f0; text-align:left; }
        td.cell { cursor: pointer; width: 40px; height: 32px; }
        td.cell.present { background: #4caf50; color: white; }
        td.cell.absent { background: #fff; color: #333; }
        .controls { margin-bottom: 12px; display:flex; gap:8px; align-items:center; }
        button { padding: 6px 10px; cursor:pointer; }
      </style>
</head>
<body>

<a href="{{ url_for('index') }}" class="back-button">← Back to Dashboard</a>

<div class="user-box">
  <span class="greeting">Hello, {{ current_user.name }}!</span>
    
  <form action="{{ url_for('logout') }}" method="get">
    <button type="submit">Logout</button>
  </form>
</div>

 <div style="display: flex; justify-content: center; align-items: center;">
    <h1 style="display: inline;"><a href="https://www.ccpstudentnews.org" style="font-family: 'Brush Script MT'; text-decoration: none; color: #222; font-size: 45px;">Cardinal and White&nbsp; </a></h1><h1 style="display: inline;">Attendance</h1>
    </div>

 <div class="controls">
    <button id="btn-add-person">Add Person</button>
    <button id="btn-add-date">Add Date</button>
    <button id="btn-refresh">Refresh</button>
  </div>

  <div id="table-wrap" style="overflow:auto; max-height:70vh;">
    <table id="attendance-table">
      <!-- built dynamically -->
    </table>
  </div>

<script>
const socket = io(); // default path

let people = [];
let dates = [];
let attendance = {}; // map "personId|dateId" -> boolean

function keyFor(p, d) { return `${p}|${d}`; }

async function loadData() {
  const resp = await fetch('/api/attendance/data');
  const data = await resp.json();
  // server returns attendance as object keyed by (person_id, date_id) but as JSON it will be string keys.
  // We'll accept either and normalize
  people = data.people || [];
  dates = data.dates || [];
  attendance = {};

  // data.attendance may be an object keyed by "('person_id', 'date_id')" or nested - we handle typical shapes:
  if (data.attendance) {
    // If keys are like "('1', '2')" or like "1,2" or like "1|2" - attempt to normalize:
    for (const k of Object.keys(data.attendance)) {
      const v = data.attendance[k];
      // try parse common formats:
      let pid, did;
      if (k.includes("|")) {
        [pid, did] = k.split("|");
      } else if (k.includes(",")) {
        [pid, did] = k.split(",").map(s => s.replace(/[^\d]/g,''));
      } else {
        // maybe object keys were number strings due to JSON mapping: try to parse
        // If it's an object like {"(1,2)": true}, remove non-digits.
        const digits = k.match(/\d+/g);
        if (digits && digits.length >= 2) {
          pid = digits[0]; did = digits[1];
        } else {
          continue;
        }
      }
      attendance[keyFor(pid, did)] = !!v;
    }
  }

  buildTable();
}

function buildTable() {
  const table = document.getElementById('attendance-table');
  table.innerHTML = '';

  // header row
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  const emptyTh = document.createElement('th');
  emptyTh.className = "person";
  emptyTh.textContent = "People \\ Dates";
  headRow.appendChild(emptyTh);

  dates.forEach(d => {
    const th = document.createElement('th');
    th.className = "date-col";
    th.dataset.dateId = d.id;
    th.textContent = (new Date(d.date)).toISOString().slice(0,10);
    th.title = "Click to delete this date";
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      if (confirm(`Delete date ${th.textContent}? This will remove all attendance entries for this date.`)) {
        deleteDate(d.id);
      }
    });
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  people.forEach(p => {
    const tr = document.createElement('tr');
    const nameTd = document.createElement('td');
    nameTd.className = "person";
    nameTd.textContent = p.name;
    nameTd.style.cursor = 'pointer';
    nameTd.title = "Click to edit / delete person";
    nameTd.addEventListener('click', () => handlePersonClick(p));
    tr.appendChild(nameTd);

    dates.forEach(d => {
      const td = document.createElement('td');
      td.className = 'cell absent';
      td.dataset.personId = p.id;
      td.dataset.dateId = d.id;
      const key = keyFor(String(p.id), String(d.id));
      const present = !!attendance[key];
      if (present) {
        td.classList.remove('absent');
        td.classList.add('present');
        td.textContent = "✓";
      } else {
        td.classList.remove('present');
        td.classList.add('absent');
        td.textContent = "";
      }

      td.addEventListener('click', (ev) => {
        // toggle locally immediately for snappy UI
        toggleCellUI(td);
        toggleCellServer(p.id, d.id); // fire request (no await) 
      });

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
}

function toggleCellUI(tdElem) {
  if (tdElem.classList.contains('present')) {
    tdElem.classList.remove('present');
    tdElem.classList.add('absent');
    tdElem.textContent = "";
  } else {
    tdElem.classList.remove('absent');
    tdElem.classList.add('present');
    tdElem.textContent = "✓";
  }
}

// server toggle call
async function toggleCellServer(personId, dateId, present=null) {
  const payload = { person_id: personId, date_id: dateId };
  if (present !== null) payload.present = present;
  try {
    const resp = await fetch('/api/attendance/toggle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await resp.json();
    // if server disagrees, we could refresh the cell. For simplicity, accept server state and update map:
    if (j && j.present !== undefined) {
      attendance[keyFor(String(personId), String(dateId))] = !!j.present;
      // ensure UI matches:
      const td = document.querySelector(`td[data-person-id='${personId}'][data-date-id='${dateId}']`);
      if (td) {
        if (j.present) { td.classList.add('present'); td.classList.remove('absent'); td.textContent='✓'; }
        else { td.classList.remove('present'); td.classList.add('absent'); td.textContent=''; }
      }
    }
  } catch (err) {
    console.error("toggle failed", err);
    // optional: reload to reconcile
    await loadData();
  }
}

async function addPerson() {
  const name = prompt("New person's name:");
  if (!name) return;
  const resp = await fetch('/api/attendance/add_person', {
    method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})
  });
  if (resp.ok) {
    await loadData();
  } else {
    const j = await resp.json();
    alert("Error: " + (j.error||resp.statusText));
  }
}

async function deletePerson(personId) {
  if (!confirm("Delete this person and their attendance rows?")) return;
  const resp = await fetch('/api/attendance/delete_person', {
    method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({person_id: personId})
  });
  if (resp.ok) {
    await loadData();
  } else {
    const j = await resp.json();
    alert("Error: " + (j.error||resp.statusText));
  }
}

function handlePersonClick(p) {
  const action = prompt(`Edit person "${p.name}":\nType 'rename' to rename or 'delete' to remove.`, "");
  if (!action) return;
  if (action.toLowerCase() === 'rename') {
    const newName = prompt("New name:", p.name);
    if (!newName) return;
    // simple serverless rename using existing Article update pattern? no endpoint yet; we'll patch Person here by calling a new endpoint or do inline:
    // Use a quick fetch to /api/attendance/rename_person
    fetch('/api/attendance/rename_person', {
      method: 'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({person_id: p.id, name: newName})
    }).then(async r => {
      if (r.ok) await loadData();
      else {
        const j = await r.json();
        alert("Error: " + (j.error || r.statusText));
      }
    });
  } else if (action.toLowerCase() === 'delete') {
    deletePerson(p.id);
  }
}

async function addDate() {
  const dateStr = prompt("Add date (YYYY-MM-DD):", new Date().toISOString().slice(0,10));
  if (!dateStr) return;
  const resp = await fetch('/api/attendance/add_date', {
    method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date: dateStr})
  });
  if (resp.ok) {
    await loadData();
  } else {
    const j = await resp.json();
    alert("Error: " + (j.error || resp.statusText));
  }
}

async function deleteDate(dateId) {
  const resp = await fetch('/api/attendance/delete_date', {
    method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date_id: dateId})
  });
  if (resp.ok) {
    await loadData();
  } else {
    const j = await resp.json();
    alert("Error: " + (j.error || resp.statusText));
  }
}

document.getElementById('btn-add-person').addEventListener('click', addPerson);
document.getElementById('btn-add-date').addEventListener('click', addDate);
document.getElementById('btn-refresh').addEventListener('click', loadData);

// Listen to socket events to update live
socket.on('connect', () => console.log('socket connected'));
socket.on('attendance_updated', (d) => {
  // d: { person_id, date_id, present }
  const key = keyFor(String(d.person_id), String(d.date_id));
  attendance[key] = !!d.present;
  const td = document.querySelector(`td[data-person-id='${d.person_id}'][data-date-id='${d.date_id}']`);
  if (td) {
    if (d.present) { td.classList.add('present'); td.classList.remove('absent'); td.textContent='✓'; }
    else { td.classList.remove('present'); td.classList.add('absent'); td.textContent=''; }
  } else {
    // If the table doesn't have that column/row (e.g., added later), refresh
    loadData();
  }
});

socket.on('person_added', (p) => {
  // simple approach: reload to avoid complex incremental insert
  loadData();
});
socket.on('person_deleted', (d) => loadData());
socket.on('date_added', (d) => loadData());
socket.on('date_deleted', (d) => loadData());

// rename person socket
socket.on('person_renamed', (d) => loadData());

// On initial load:
loadData();
</script>
</body>
</html>
</body>
</html>