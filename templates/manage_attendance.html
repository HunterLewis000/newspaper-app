<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='ccp.ico') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f0f0f0; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 8px; min-width: 300px; }
        .close { float: right; cursor: pointer; font-size: 20px; }
        button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>

<a href="{{ url_for('index') }}" class="back-button">← Back to Dashboard</a>

<div class="user-box">
  <span class="greeting">Hello, {{ current_user.name }}!</span>
    
  <form action="{{ url_for('logout') }}" method="get">
    <button type="submit">Logout</button>
  </form>
</div>

 <div style="display: flex; justify-content: center; align-items: center;">
    <h1 style="display: inline;"><a href="https://www.ccpstudentnews.org" style="font-family: 'Brush Script MT'; text-decoration: none; color: #222; font-size: 45px;">Cardinal and White&nbsp; </a></h1><h1 style="display: inline;">Attendance</h1>
    </div>

    <button id="add-person-btn">Add Person</button>
    <button id="add-date-btn">Add Date</button>

    <table id="attendance-table">
        <thead>
            <tr id="attendance-header-row">
                <th>Person</th>
                {% for date in dates %}
                <th data-date-id="{{ date.id }}">
                    {{ date.date }}
                    <span class="delete-btn" data-date-id="{{ date.id }}">x</span>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for person in people %}
            <tr class="attendance-row" data-person-id="{{ person.id }}">
                <td>
                    {{ person.name }}
                    <span class="delete-btn delete-person-btn" data-person-id="{{ person.id }}">x</span>
                </td>
                {% for date in dates %}
                <td>
                    <input type="checkbox" class="attendance-checkbox"
                           data-person-id="{{ person.id }}"
                           data-date-id="{{ date.id }}"
                           {% if attendance.get((person.id, date.id)) %}checked{% endif %}>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Add Person Modal -->
    <div id="person-modal" class="modal">
        <div class="modal-content">
            <h3>Add Person</h3>
            <input type="text" id="new-person-name" placeholder="Person Name">
            <button id="save-person-btn">Save</button>
            <button id="close-person-modal">Cancel</button>
        </div>
    </div>

    <!-- Add Date Modal -->
    <div id="date-modal" class="modal">
        <div class="modal-content">
            <h3>Add Date</h3>
            <input type="date" id="new-date">
            <button id="save-date-btn">Save</button>
            <button id="close-date-modal">Cancel</button>
        </div>
    </div>

    <script>
        const socket = io();

        // -------------------
        // Add Person Modal
        // -------------------
        const personModal = document.getElementById("person-modal");
        document.getElementById("add-person-btn").onclick = () => personModal.classList.add("show");
        document.getElementById("close-person-modal").onclick = () => personModal.classList.remove("show");

        document.getElementById("save-person-btn").onclick = () => {
            const name = document.getElementById("new-person-name").value.trim();
            if(!name) return alert("Enter a name");
            socket.emit("add_person", { name });
            document.getElementById("new-person-name").value = "";
            personModal.classList.remove("show");
        }

        // -------------------
        // Add Date Modal
        // -------------------
        const dateModal = document.getElementById("date-modal");
        document.getElementById("add-date-btn").onclick = () => dateModal.classList.add("show");
        document.getElementById("close-date-modal").onclick = () => dateModal.classList.remove("show");

        document.getElementById("save-date-btn").onclick = () => {
            const date = document.getElementById("new-date").value;
            if(!date) return alert("Pick a date");
            socket.emit("add_date", { date });
            document.getElementById("new-date").value = "";
            dateModal.classList.remove("show");
        }

        // -------------------
        // Add / Delete Live Updates
        // -------------------
        socket.on("person_added", data => {
            const tbody = document.querySelector("#attendance-table tbody");
            const tr = document.createElement("tr");
            tr.classList.add("attendance-row");
            tr.dataset.personId = data.id;
            tr.innerHTML = `<td>${data.name} <span class="delete-btn delete-person-btn" data-person-id="${data.id}">x</span></td>`;
            
            // Add checkbox cells for existing dates
            document.querySelectorAll("#attendance-header-row th[data-date-id]").forEach(th => {
                const td = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.classList.add("attendance-checkbox");
                checkbox.dataset.personId = data.id;
                checkbox.dataset.dateId = th.dataset.dateId;
                td.appendChild(checkbox);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        socket.on("date_added", data => {
            // Add header
            const th = document.createElement("th");
            th.dataset.dateId = data.id;
            th.innerHTML = `${data.date} <span class="delete-btn" data-date-id="${data.id}">x</span>`;
            document.getElementById("attendance-header-row").appendChild(th);

            // Add checkbox cell for each person row
            document.querySelectorAll(".attendance-row").forEach(tr => {
                const td = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.classList.add("attendance-checkbox");
                checkbox.dataset.personId = tr.dataset.personId;
                checkbox.dataset.dateId = data.id;
                td.appendChild(checkbox);
                tr.appendChild(td);
            });
        });

        socket.on("person_toggled", data => {
            if(!data.active) {
                document.querySelector(`.attendance-row[data-person-id="${data.person_id}"]`)?.remove();
            }
        });

        socket.on("date_toggled", data => {
            const idx = Array.from(document.querySelectorAll("#attendance-header-row th")).findIndex(th => th.dataset.dateId == data.date_id);
            if(idx >= 0){
                document.querySelectorAll("#attendance-table tr").forEach(tr => {
                    tr.removeChild(tr.children[idx]);
                });
            }
        });

        // -------------------
        // Checkbox change
        // -------------------
        document.addEventListener("change", e => {
            if(e.target.classList.contains("attendance-checkbox")){
                const personId = e.target.dataset.personId;
                const dateId = e.target.dataset.dateId;
                const present = e.target.checked;
                socket.emit("update_attendance", { person_id: personId, date_id: dateId, present });
            }
        });

        // -------------------
        // Delete buttons
        // -------------------
        document.addEventListener("click", e => {
            if(e.target.classList.contains("delete-person-btn")){
                socket.emit("toggle_person", { person_id: e.target.dataset.personId, active: false });
            }
            if(e.target.classList.contains("delete-btn") && e.target.dataset.dateId){
                socket.emit("toggle_date", { date_id: e.target.dataset.dateId, delete: true });
            }
        });
    </script>
</body>
</html>
</body>
</html>