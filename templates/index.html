<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Cardinal and White Story Tracker</h1>

    <form method="POST" action="/add">
        <input type="text" name="title" placeholder="Article Title" required>
        <input type="text" name="author" placeholder="Author Name" required>
        <input type="date" name="deadline">
        <button type="submit">Add Article</button>
    </form>


<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Author</th>
      <th>Status</th>
      <th>Deadline</th>
      <th>Files</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for article in articles %}
    <tr id="row-{{ article.id }}">
      <td class="title">{{ article.title }}</td>
      <td class="author">{{ article.author }}</td>
      <td class="status">
        <select onchange="updateStatus({{ article.id }}, this.value)">
          <option value="Not Started" {% if article.status == 'Not Started' %}selected{% endif %}>Not Started</option>
          <option value="Done" {% if article.status == 'Done' %}selected{% endif %}>Done</option>
          <option value="Edited" {% if article.status == 'Edited' %}selected{% endif %}>Edited</option>
          <option value="Published" {% if article.status == 'Published' %}selected{% endif %}>Published</option>
        </select>
      </td>
      <td class="deadline" data-deadline="{{ article.deadline }}">{{ article.deadline }}</td>

      <!-- Files column -->
      <td>
        <button class="file-icon-btn" onclick="openFileManager({{ article.id }})">Files</button>
      </td>

      <!-- Actions column -->
      <td>
        <button onclick="toggleEdit({{ article.id }})" id="edit-btn-{{ article.id }}">Edit</button>
        <button onclick="deleteArticle({{ article.id }})" style="color:red;">Delete</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>



<div id="fileManagerModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button type="button" class="close" aria-label="Close" onclick="closeFileManager()">×</button>

    <h3>Files</h3>

    <ul id="fileList" class="file-list"></ul>

    <div class="upload-section">
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" required />
        <button type="submit">Upload</button>
      </form>
    </div>
  </div>
</div>



<script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-A9xjF58i..." crossorigin="anonymous"></script>
<script>
<script>
  let currentArticleId = null;

  function openFileManager(articleId) {
    currentArticleId = articleId;
    document.getElementById('fileManagerModal').style.display = 'block';
    document.getElementById('fileManagerModal').setAttribute('aria-hidden', 'false');
    loadFiles(articleId);
  }

  function closeFileManager() {
    document.getElementById('fileManagerModal').style.display = 'none';
    document.getElementById('fileManagerModal').setAttribute('aria-hidden', 'true');
    currentArticleId = null;
    // Optional: clear list
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('uploadForm').reset();
  }

  // Close when clicking outside the panel
  window.addEventListener('click', (e) => {
    const modal = document.getElementById('fileManagerModal');
    if (e.target === modal) closeFileManager();
  });
  // Close on ESC
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeFileManager();
  });

  function loadFiles(articleId) {
    fetch(`/files/${articleId}`)
      .then(r => r.json())
      .then(data => {
        const ul = document.getElementById('fileList');
        ul.innerHTML = '';
        (data.files || []).forEach(f => {
          const li = document.createElement('li');
          li.id = `file-${f.id}`;
          li.innerHTML = `
            <a href="${f.preview_url}" target="_blank" rel="noopener">${f.filename}</a>
            <button onclick="deleteFile(${f.id})" style="color:red;">Delete</button>
          `;
          ul.appendChild(li);
        });
      })
      .catch(err => console.error('loadFiles error:', err));
  }

  // Upload handler for the modal form
  document.getElementById('uploadForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if (!currentArticleId) return;

    const formData = new FormData(e.target);
    fetch(`/upload/${currentArticleId}`, { method: 'POST', body: formData })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // Refresh list after upload
          loadFiles(currentArticleId);
          // Socket broadcast is already emitted by server; this keeps local modal fresh immediately
        } else {
          alert('Upload failed: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(err => alert('Network error: ' + err));
  });

  function deleteFile(fileId) {
    if (!confirm('Delete this file?')) return;
    fetch(`/delete_file/${fileId}`, { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          const li = document.getElementById(`file-${fileId}`);
          if (li) li.remove();
          socket.emit('file_deleted', { file_id: fileId });
        } else {
          alert('Error deleting file!');
        }
      })
      .catch(err => alert('Network error: ' + err));
  }

  // If you add rows live via socket, make sure the new row includes the Files column:
  socket.on('article_added', data => {
    const tbody = document.querySelector('table tbody');
    const row = document.createElement('tr');
    row.id = `row-${data.id}`;
    row.innerHTML = `
      <td class="title">${data.title}</td>
      <td class="author">${data.author}</td>
      <td class="status">
        <select onchange="updateStatus(${data.id}, this.value)">
          <option value="Not Started" ${data.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
          <option value="Done" ${data.status === 'Done' ? 'selected' : ''}>Done</option>
          <option value="Edited" ${data.status === 'Edited' ? 'selected' : ''}>Edited</option>
          <option value="Published" ${data.status === 'Published' ? 'selected' : ''}>Published</option>
        </select>
      </td>
      <td class="deadline">${data.deadline || ''}</td>
      <td><button class="file-icon-btn" onclick="openFileManager(${data.id})">Files</button></td>
      <td>
        <button onclick="toggleEdit(${data.id})" id="edit-btn-${data.id}">Edit</button>
        <button onclick="deleteArticle(${data.id})" style="color:red;">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
</script>

</script>
<script>
  const socket = io();

  // Toggle edit mode for a row
  function toggleEdit(articleId) {
    const row = document.getElementById(`row-${articleId}`);
    const editBtn = document.getElementById(`edit-btn-${articleId}`);

    if (editBtn.textContent === "Edit") {
      // Switch to edit mode
      const title = row.querySelector('.title').textContent;
      const author = row.querySelector('.author').textContent;
      const deadline = row.querySelector('.deadline').textContent;

      row.querySelector('.title').innerHTML = `<input type="text" value="${title}" id="title-input-${articleId}">`;
      row.querySelector('.author').innerHTML = `<input type="text" value="${author}" id="author-input-${articleId}">`;
      row.querySelector('.deadline').innerHTML = `<input type="date" value="${deadline}" id="deadline-input-${articleId}">`;

      editBtn.textContent = "Done";

    } else {
      // Save edits
      const newTitle = document.getElementById(`title-input-${articleId}`).value.trim();
      const newAuthor = document.getElementById(`author-input-${articleId}`).value.trim();
      const newDeadline = document.getElementById(`deadline-input-${articleId}`).value;

      fetch(`/update/${articleId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: newTitle,
          author: newAuthor,
          deadline: newDeadline
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          row.querySelector('.title').textContent = newTitle;
          row.querySelector('.author').textContent = newAuthor;
          row.querySelector('.deadline').textContent = newDeadline;
          editBtn.textContent = "Edit";

          // Emit update to other clients
          socket.emit('article_updated', {
            id: articleId,
            title: newTitle,
            author: newAuthor,
            deadline: newDeadline
          });
        } else {
          alert("Failed to save changes.");
        }
      });
    }
  }



  // Update status
  function updateStatus(articleId, newStatus) {
    fetch(`/update_status/${articleId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        socket.emit('status_updated', { id: articleId, status: newStatus });
      } else {
        alert('Error updating status!');
      }
    });
  }

  // Delete article
  function deleteArticle(articleId) {
    if (confirm("Are you sure you want to delete this article?")) {
      fetch(`/delete/${articleId}`, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const row = document.getElementById(`row-${articleId}`);
          if (row) row.remove();

          // Emit deletion to other clients
          socket.emit('article_deleted', { id: articleId });
        } else {
          alert('Error deleting article!');
        }
      })
      .catch(err => alert('Network error deleting article: ' + err));
    }
  }


  // Socket.IO listeners for live updates
  socket.on('article_added', data => {
    const tbody = document.querySelector('table tbody');
    const row = document.createElement('tr');
    row.id = `row-${data.id}`;
    row.innerHTML = `
      <td class="title">${data.title}</td>
      <td class="author">${data.author}</td>
      <td class="status">
        <select onchange="updateStatus(${data.id}, this.value)">
          <option value="Not Started" ${data.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
          <option value="Done" ${data.status === 'Done' ? 'selected' : ''}>Done</option>
          <option value="Edited" ${data.status === 'Edited' ? 'selected' : ''}>Edited</option>
          <option value="Published" ${data.status === 'Published' ? 'selected' : ''}>Published</option>
        </select>
      </td>
      <td class="deadline">${data.deadline}</td>
      <td>
        <button onclick="toggleEdit(${data.id})" id="edit-btn-${data.id}">Edit</button>
        <button onclick="deleteArticle(${data.id})" style="color:red;">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  socket.on('article_updated', data => {
    const row = document.getElementById(`row-${data.id}`);
    if (row) {
      row.querySelector('.title').textContent = data.title;
      row.querySelector('.author').textContent = data.author;
      row.querySelector('.deadline').textContent = data.deadline;
    }
  });

  socket.on('status_updated', data => {
    const row = document.getElementById(`row-${data.id}`);
    if (row) row.querySelector('select').value = data.status;
  });

  socket.on('article_deleted', data => {
    const row = document.getElementById(`row-${data.id}`);
    if (row) row.remove();
  });
  socket.on('file_uploaded', data => {
    const ul = document.getElementById(`file-list-${data.articleId}`);
    if (!ul) return;
    const li = document.createElement('li');
    li.id = `file-${data.file_id}`;
    li.innerHTML = `<a href="${data.file_url}" target="_blank">${data.filename}</a>
                    <button onclick="deleteFile(${data.file_id})" style="color:red;">X</button>`;
    ul.appendChild(li);
});

socket.on('file_deleted', data => {
    const li = document.getElementById(`file-${data.fileId}`);
    if (li) li.remove();
});

</script>
</body>
</html>
