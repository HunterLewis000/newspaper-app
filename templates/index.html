<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>C&W Story Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Cardinal and White Story Tracker</h1>

    <form method="POST" action="/add">
        <input type="text" name="title" placeholder="Article Title" required>
        <input type="text" name="author" placeholder="Author Name" required>
        <input type="date" name="deadline">
        <button type="submit">Add Article</button>
    </form>

<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Author</th>
      <th>Status</th>
      <th>Deadline</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for article in articles %}
    <tr id="row-{{ article.id }}">
      <td class="title">{{ article.title }}</td>
      <td class="author">{{ article.author }}</td>
      <td class="status">
        <select onchange="updateStatus({{ article.id }}, this.value)">
          <option value="Not Started" {% if article.status == 'Not Started' %}selected{% endif %}>Not Started</option>
          <option value="Done" {% if article.status == 'Done' %}selected{% endif %}>Done</option>
          <option value="Edited" {% if article.status == 'Edited' %}selected{% endif %}>Edited</option>
          <option value="Published" {% if article.status == 'Published' %}selected{% endif %}>Published</option>
        </select>
      </td>
      <td class="deadline" data-deadline="{{ article.deadline }}">{{ article.deadline }}</td>
      <td>
        <button onclick="toggleEdit({{ article.id }})" id="edit-btn-{{ article.id }}">Edit</button>
        <button onclick="deleteArticle({{ article.id }})" style="color:red;">Delete</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  function toggleEdit(articleId) {
    const row = document.getElementById(`row-${articleId}`);
    const editBtn = document.getElementById(`edit-btn-${articleId}`);

    if (editBtn.textContent === "Edit") {
      // Switch to edit mode for title, author, deadline only
      const title = row.querySelector('.title').textContent;
      const author = row.querySelector('.author').textContent;
      const deadline = row.querySelector('.deadline').textContent;

      row.querySelector('.title').innerHTML = `<input type="text" value="${title}" id="title-input-${articleId}">`;
      row.querySelector('.author').innerHTML = `<input type="text" value="${author}" id="author-input-${articleId}">`;
      row.querySelector('.deadline').innerHTML = `<input type="date" value="${deadline}" id="deadline-input-${articleId}">`;

      editBtn.textContent = "Done";

    } else {
      // Save edits for title, author, deadline only
      const newTitle = document.getElementById(`title-input-${articleId}`).value.trim();
      const newAuthor = document.getElementById(`author-input-${articleId}`).value.trim();
      const newDeadline = document.getElementById(`deadline-input-${articleId}`).value;

      fetch(`/update/${articleId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: newTitle,
          author: newAuthor,
          deadline: newDeadline
          // status NOT included because it's live editable always
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          row.querySelector('.title').textContent = newTitle;
          row.querySelector('.author').textContent = newAuthor;
          row.querySelector('.deadline').textContent = newDeadline;

          editBtn.textContent = "Edit";
        } else {
          alert("Failed to save changes.");
        }
      });
    }
  }

  function updateStatus(articleId, newStatus) {
    fetch(`/update_status/${articleId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
      if (!data.success) {
        alert('Error updating status!');
      }
    });
  }

  function deleteArticle(articleId) {
    if (confirm("Are you sure you want to delete this article?")) {
        fetch(`/delete/${articleId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`row-${articleId}`).remove();
            } else {
                alert('Error deleting article!');
            }
        })
        .catch(error => {
            alert('Network error deleting article: ' + error);
        });
    }
}

</script>

</body>
</html>
